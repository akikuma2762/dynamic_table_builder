<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>æš«å­˜ / å®Œæˆ å€</title>
    <link
      href="https://cdn.jsdelivr.net/npm/quill@2.0.0/dist/quill.snow.css"
      rel="stylesheet"
    />
    <style>
      /* --- èˆ‡å‰ç‰ˆç›¸åŒçš„æ¨£å¼ --- */
      body {
        font-family: "Segoe UI", Roboto, "Noto Sans TC", sans-serif;
        margin: 1.5rem;
      }

      #controls button {
        margin-right: 0.5rem;
        padding: 4px 10px;
      }

      #palette {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        padding: 0.5rem;
        border: 1px dashed #999;
        max-width: 100%;
      }

      .draggable-item {
        background: #fffbe6;
        border: 1px solid #f0c36d;
        padding: 0.4rem;
        cursor: grab;
        width: 420px;
      }

      .reusable {
        background: #e1f5fe;
        border-color: #03a9f4;
        width: 220px;
      }

      table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 1rem;
      }

      th,
      td {
        border: 1px solid #999;
        padding: 0.6rem;
        min-height: 44px;
        text-align: left;
        vertical-align: top;
      }

      th {
        background: #f5f5f5;
      }

      td.drop-hover {
        background: #c8e6c9;
      }

      #outputArea,
      #savedArea {
        margin-top: 2rem;
        border: 2px dashed #aaa;
        padding: 1rem;
      }

      .saved-block {
        border: 1px solid #777;
        padding: 0.5rem;
        margin-top: 0.8rem;
      }

      .saved-title {
        font-weight: bold;
        margin-bottom: 0.4rem;
      }

      .buttons-inline > button {
        margin-right: 0.5rem;
      }

      textarea {
        width: 180px;
        height: 60px;
        font-family: inherit;
      }

      .draggable-item textarea {
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        resize: vertical;
        overflow-wrap: break-word;
      }

      .signature {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        align-items: center;
      }

      .sigCanvas {
        border: 1px solid #666;
        background: #fff;
        width: 100%;
        height: 60px;
        touch-action: none;
      }

      .clearSig {
        font-size: 0.75rem;
      }

      #sigModal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }

      #sigModal .modal-box {
        background: #fff;
        padding: 1rem;
        border-radius: 6px;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      #sigModal canvas {
        border: 1px solid #333;
      }

      .draggable-item .del-btn {
        text-align: end;
        font-size: 0.8rem;
        color: #f44336;
        cursor: pointer;
        user-select: none;
      }

      #builderPreview {
        border: 1px dashed #ccc;
        padding: 0.5rem;
        min-height: 40px;
        background: #fafafa;
      }

      .row-selected {
        background: #e3f2fd !important;
        color: #000 !important;
      }

      table.preview {
        text-align: center;
      }

      /* ----- Palette åˆ†å€æ¨£å¼ ----- */
      #palette {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .palette-block {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        padding: 0.5rem;
        border: 1px dashed #999;
      }

      .palette-block.native {
        background: #fffbe6;
        border-color: #f0c36d;
      }

      .palette-block.custom {
        background: #e8fbe9;
        border-color: #4caf50;
      }
    </style>
  </head>
  <body>
    <h3>æš«å­˜ / å®Œæˆ å€</h3>
    <div id="savedArea"></div>
    <button id="reloadBtn">é‡æ–°è®€å–</button>

    <!-- -------- ç°½å Modal -------- -->
    <div id="sigModal">
      <div class="modal-box">
        <canvas id="modalCanvas" width="400" height="200"></canvas>
        <div>
          <button id="modalClear">æ¸…é™¤</button
          ><button id="modalSave">å„²å­˜</button
          ><button id="modalCancel">å–æ¶ˆ</button>
        </div>
      </div>
    </div>

    <script>
      function readJSON(k) {
        const r = localStorage.getItem(k);
        return r ? JSON.parse(r) : null;
      }

      const contrast = (h) => {
        const r = parseInt(h.substr(1, 2), 16),
          g = parseInt(h.substr(3, 2), 16),
          b = parseInt(h.substr(5, 2), 16);
        return (r * 299 + g * 587 + b * 114) / 1000 >= 128 ? "#000" : "#fff";
      };

      const uid = () => `id_${Math.random().toString(36).slice(2, 10)}`;

      /* ===== leaf ===== */
      function leafCols(hRows) {
        const R = hRows.length,
          g = [];
        for (let r = 0; r < R; r++) {
          g[r] ??= [];
          let c = 0;
          hRows[r].forEach((cell) => {
            while (g[r][c]) c++;
            const cs = +cell.colspan || 1,
              rs = +cell.rowspan || 1;
            for (let rr = 0; rr < rs; rr++)
              for (let cc = 0; cc < cs; cc++) {
                g[r + rr] ??= [];
                g[r + rr][c + cc] = cell;
              }
            c++;
          });
        }
        return g[R - 1] || [];
      }

      function enableDrag(tbl) {
        tbl.addEventListener("dragover", (e) => {
          if (e.target.tagName === "TD") {
            e.preventDefault();
            e.target.classList.add("drop-hover");
          }
        });
        tbl.addEventListener("dragleave", (e) => {
          if (e.target.tagName === "TD")
            e.target.classList.remove("drop-hover");
        });
        tbl.addEventListener("drop", (e) => {
          if (e.target.tagName !== "TD") return;
          e.preventDefault();
          e.target.classList.remove("drop-hover");
          const id = e.dataTransfer.getData("text/plain");
          const src = document.getElementById(id);
          if (!src) return;
          if (e.target.firstChild && !confirm("è¦†è“‹æ­¤æ ¼ï¼Ÿ")) return;
          const el = src.classList.contains("reusable")
            ? src.cloneNode(true)
            : src;
          el.id = "";
          el.draggable = false;
          el.style.cursor = "default";
          /* â˜… è‹¥æ ¼å­å…§å«åˆªé™¤éˆ•ï¼Œé»ä¸€ä¸‹å°±æŠŠæ•´æ ¼å…§å®¹æ¸…æ‰ */
          const del = el.querySelector(".del-btn");
          if (del) {
            del.onclick = (ev) => {
              ev.stopPropagation();
              const td = del.closest("td");
              if (td) td.innerHTML = "&nbsp;"; // è®Šå›ç©ºç™½æ ¼
            };
          }

          e.target.innerHTML = "";
          e.target.appendChild(el);
          initSignature(el);
        });
      }

      function initSignature(holder) {
        const cvs = holder.querySelector(".sigCanvas");
        if (!cvs || cvs.dataset.bound) return;
        cvs.dataset.bound = 1;
        const ctx = cvs.getContext("2d");
        ctx.lineWidth = 2;
        ctx.lineCap = "round";
        let down = false,
          prev = null;
        const pos = (e) => {
          const r = cvs.getBoundingClientRect();
          return {
            x: (e.touches ? e.touches[0].clientX : e.clientX) - r.left,
            y: (e.touches ? e.touches[0].clientY : e.clientY) - r.top,
          };
        };
        const start = (e) => {
          down = true;
          prev = pos(e);
        };
        const move = (e) => {
          if (!down) return;
          const p = pos(e);
          ctx.beginPath();
          ctx.moveTo(prev.x, prev.y);
          ctx.lineTo(p.x, p.y);
          ctx.stroke();
          prev = p;
          e.preventDefault();
        };
        cvs.onmousedown = start;
        cvs.onmousemove = move;
        window.addEventListener("mouseup", () => (down = false));
        cvs.ontouchstart = start;
        cvs.ontouchmove = move;
        cvs.ontouchend = () => (down = false);
        holder
          .querySelector(".clearSig")
          ?.addEventListener("click", () =>
            ctx.clearRect(0, 0, cvs.width, cvs.height)
          );
        cvs.onclick = () => {
          if (cvs.draggable === false) {
            smallCvs = cvs;
            mCtx.clearRect(0, 0, modalCanvas.width, modalCanvas.height);
            mCtx.drawImage(cvs, 0, 0, modalCanvas.width, modalCanvas.height);
            sigModal.style.display = "flex";
          }
        };
      }

      function buildTableFromV7(v7, readOnly = false) {
        const leaf = leafCols(v7.headerRows);
        console.log("leafCols:", leaf);
        const colgroup =
          "<colgroup>" +
          leaf.map((l) => `<col style="width:${l.width || ""}%;">`).join("") +
          "</colgroup>";
        const hBg = "#d9eaff",
          hColor = contrast(hBg);
        const thead = v7.headerRows
          .map(
            (r) =>
              "<tr>" +
              r
                .map(
                  (c) =>
                    `<th${c.colspan > 1 ? ` colspan="${c.colspan}"` : ""}${
                      c.rowspan > 1 ? ` rowspan="${c.rowspan}"` : ""
                    }${c.en ? ` data-column="${c.en}"` : ""} 
                    style="text-align:${c.align || "left"};
            color:${c.color || "#000"};
            font-size:${c.size || 16}px;">
        ${c.text || "&nbsp;"}${c.en ? `<br><small>${c.en}</small>` : ""}</th>`
                )
                .join("") +
              "</tr>"
          )
          .join("");

        const rows = v7.dataRowsCfg.length,
          cols = leaf.length,
          occ = Array(rows)
            .fill(0)
            .map(() => Array(cols).fill(false));
        const tb = [];
        for (let r = 0; r < rows; r++) {
          const bg = v7.dataRowsCfg[r].color || "#ffffff",
            txt = contrast(bg);
          let tr = `<tr style="background:${bg};color:${txt};">`;
          for (let c = 0; c < cols; c++) {
            if (occ[r][c]) continue;
            const cell = v7.dataRowsCfg[r].cells[c] || {};
            let cs = +cell.colspan || 1,
              rs = +cell.rowspan || 1;
            if (c + cs > cols) cs = cols - c;
            if (r + rs > rows) rs = rows - r;
            for (let rr = 0; rr < rs; rr++)
              for (let cc = 0; cc < cs; cc++) occ[r + rr][c + cc] = true;
            const data =
              cs === 1 && rs === 1 && leaf[c]?.en
                ? ` data-column="${leaf[c].en}"`
                : "";
            // è®€å– cell align/color/sizeï¼Œè‹¥ç„¡å‰‡é è¨­
            const align = cell.align || "left";
            const fColor = cell.color || "#000";
            const fSize = cell.size || 16;
            const htmlText = cell.text || cell.html || "&nbsp;";
            tr += `<td${data}${cs > 1 ? ` colspan="${cs}"` : ""}${
              rs > 1 ? ` rowspan="${rs}"` : ""
            }
              style="text-align:${align};color:${fColor};font-size:${fSize}px;">
              ${htmlText}
              </td>`;
          }
          tr += "</tr>";
          tb.push(tr);
        }
        const tbl = document.createElement("table");
        tbl.innerHTML = `<style>.preview th{background:${hBg};color:${hColor};}</style>${colgroup}<thead>${thead}</thead><tbody>${tb.join(
          ""
        )}</tbody>`;
        tbl.className = "preview";
        tbl.id = "mainTable";

        /* â˜… é‚„åŸ canvas å…§å®¹ï¼Œå†æ±ºå®šæ˜¯å¦é–å®š */
        tbl.querySelectorAll("canvas.sigCanvas").forEach((cv) => {
          const url = cv.getAttribute("data-url");
          if (url) {
            const img = new Image();
            img.onload = () => {
              cv.getContext("2d").drawImage(img, 0, 0, cv.width, cv.height);
            };
            img.src = url;
          }
        });

        if (readOnly) {
          tbl
            .querySelectorAll("input,textarea,canvas")
            .forEach((el) => (el.style.pointerEvents = "none"));
        } else {
          tbl.querySelectorAll(".signature").forEach(initSignature);
          enableDrag(tbl);
        }
        return tbl;
      }

      function attachRowSelect(tbl) {
        tbl.addEventListener("click", (e) => {
          const tr = e.target.closest("tr");
          if (!tr) return;
          tr.classList.toggle("row-selected"); // ç¬¬äºŒæ¬¡å†é»æœƒç§»é™¤åº•è‰²
          var result = getSelectedRowsData(tbl); // é å…ˆå‘¼å«ä¸€æ¬¡ï¼Œç¢ºä¿å‡½å¼å­˜åœ¨
          console.log("å·²ç¶å®šè¡Œé¸æ“‡åŠŸèƒ½ï¼Œé»é¸è¡Œå¯åˆ‡æ›é¸ä¸­ç‹€æ…‹ã€‚");
          console.log("é¸ä¸­è¡Œè³‡æ–™ï¼š", result); // åˆå§‹æ™‚æ²’æœ‰é¸ä¸­è¡Œï¼Œçµæœç‚ºç©ºé™£åˆ—
        });
      }

      function getSelectedRowsData(tbl) {
        const rows = [...tbl.querySelectorAll("tr.row-selected")];
        return rows.map((r) => {
          const obj = {};
          r.querySelectorAll("td[data-column]").forEach((td) => {
            obj[td.dataset.column] = td.innerText.trim();
          });
          return obj;
        });
      }

      function refreshSavedArea() {
        const area = document.getElementById("savedArea");
        if (!area) return;
        // ä¿ç•™é è¦½å€å¡Šèˆ‡ä¸‹æ‹‰é¸å–®ã€æŒ‰éˆ•
        const previewBlock = area.querySelector('.preview-block');
        const previewSelect = document.getElementById('previewSelect');
        const previewLoadBtn = document.getElementById('previewLoadBtn');
        area.innerHTML = "";
        if (previewSelect) area.appendChild(previewSelect);
        if (previewLoadBtn) area.appendChild(previewLoadBtn);
        if (previewBlock) area.appendChild(previewBlock);

        // å–å¾—ç›®å‰é¸å–çš„é è¦½åç¨±
        const sel = document.getElementById("previewSelect");
        const previewName = sel && sel.value ? sel.value : null;
        if (!previewName) return;
        // è®€å– dynamicTableMultiPreview__{name} è³‡æ–™
        const raw = localStorage.getItem("dynamicTableMultiPreview__" + previewName);
        console.log("è®€å–é è¦½è³‡æ–™ï¼š", raw);
        let previewData = null;
        if (raw) {
          try { previewData = JSON.parse(raw); } catch (e) { previewData = null; }
        }
        if (!previewData || !Array.isArray(previewData.configs)) return;

        // æš«å­˜å€ï¼ˆå¯ç·¨è¼¯ï¼‰
        const wrap = document.createElement("div");
        wrap.className = "saved-block";
        wrap.innerHTML = '<div class="saved-title">æš«å­˜ç‰ˆ (å¯ç·¨è¼¯)</div>';
        // æ–°å¢ã€Œä¿®æ”¹ã€èˆ‡ã€Œå®Œæˆã€æŒ‰éˆ•
        const btnBar = document.createElement("div");
        btnBar.className = "buttons-inline";
        const btnEdit = document.createElement("button");
        btnEdit.textContent = "ä¿®æ”¹";
        const btnFinish = document.createElement("button");
        btnFinish.textContent = "å®Œæˆ";
        btnBar.appendChild(btnEdit);
        btnBar.appendChild(btnFinish);
        wrap.appendChild(btnBar);
        // è¡¨æ ¼å…§å®¹
        previewData.configs.forEach((v7, idx) => {
          const tbl = buildTableFromV7(v7, false);
          wrap.appendChild(tbl);
          tbl.querySelectorAll(".signature").forEach(initSignature);
        });
        area.appendChild(wrap);
        // ä¿®æ”¹æŒ‰éˆ•
        let isEditing = true;
        btnEdit.onclick = () => {
          if (!isEditing) {
            // åˆ‡å›å¯ç·¨è¼¯
            [...wrap.querySelectorAll("table")].forEach(tbl => {
              tbl.querySelectorAll("input,textarea,canvas").forEach(el => (el.style.pointerEvents = ""));
              tbl.querySelectorAll(".signature").forEach(initSignature);
              enableDrag(tbl);
            });
            btnEdit.textContent = "å„²å­˜ä¿®æ”¹";
            btnFinish.disabled = false;
            isEditing = true;
          } else {
            // å„²å­˜ä¿®æ”¹ï¼ˆä½†ä¸åˆ‡å”¯è®€ï¼‰
            const tables = [...wrap.querySelectorAll("table")];
            let obj = {};
            const raw = localStorage.getItem("dynamicTableMultiPreview__" + previewName);
            if (raw) {
              try { obj = JSON.parse(raw); } catch (e) { obj = {}; }
            }
            const multi = { configs: tables.map((tbl, idx) => domToV7(tbl, obj.configs ? obj.configs[idx]?.headerRows : [])) };
            localStorage.setItem("dynamicTableMultiPreview__" + previewName, JSON.stringify(multi));
            alert("å·²å„²å­˜ä¿®æ”¹");
            btnEdit.textContent = "ä¿®æ”¹";
            isEditing = false;
          }
        };
        // å®ŒæˆæŒ‰éˆ•ï¼šå°‡ç›®å‰ç•«é¢å…§å®¹å­˜å› dynamicTableMultiPreview__{name} ä¸¦åˆ‡å”¯è®€
        btnFinish.onclick = () => {
          const tables = [...wrap.querySelectorAll("table")];
          let obj = {};
          const raw = localStorage.getItem("dynamicTableMultiPreview__" + previewName);
          if (raw) {
            try { obj = JSON.parse(raw); } catch (e) { obj = {}; }
          }
          const multi = { configs: tables.map((tbl, idx) => domToV7(tbl, obj.configs ? obj.configs[idx]?.headerRows : [])) };
          localStorage.setItem("dynamicTableMultiPreview__" + previewName, JSON.stringify(multi));
          // åªé‡å°å®Œæˆç‰ˆå€å¡Šï¼ˆfinWrapï¼‰åˆ‡å”¯è®€
          if (finWrap) {
            finWrap.querySelectorAll("table").forEach(tbl => {
              tbl.querySelectorAll("input,textarea,canvas").forEach(el => (el.style.pointerEvents = "none"));
            });
          }
          btnFinish.disabled = true;
          btnEdit.textContent = "ä¿®æ”¹";
          isEditing = false;
          alert("å·²å®Œæˆä¸¦åˆ‡æ›ç‚ºå”¯è®€");
          refreshSavedArea();
        };

        // å®Œæˆå€ï¼ˆå”¯è®€ï¼‰
        const finWrap = document.createElement("div");
        finWrap.className = "saved-block";
        finWrap.innerHTML = '<div class="saved-title">å®Œæˆç‰ˆ (å”¯è®€)</div>';
        previewData.configs.forEach((v7, idx) => {
          const tbl = buildTableFromV7(v7, true);
          finWrap.appendChild(tbl);
          // åƒè€ƒ inspection_form_saved_area.html çš„å”¯è®€è™•ç†
          tbl.querySelectorAll("input,textarea").forEach(el => el.disabled = true);
          tbl.querySelectorAll("canvas").forEach(el => el.style.pointerEvents = "none");
          tbl.style.pointerEvents = ""; // è§£é™¤æ•´è¡¨é–å®šï¼Œåƒ…é–å®šäº’å‹•å…ƒä»¶
          tbl.addEventListener("click", attachRowSelect(tbl));
        });
        area.appendChild(finWrap);
      }

      // ===== å¤šè¡¨æ ¼ä¸‹æ‹‰é¸å–®èˆ‡è®€å– dynamicTableMultiPreview__ ç›¸é—œè³‡æ–™ =====
const PREVIEW_LIST_KEY = "dynamicTableMultiPreview__names";
function getPreviewNameList(){
  try{ return JSON.parse(localStorage.getItem(PREVIEW_LIST_KEY)) || []; }
  catch(e){ return []; }
}
function refreshPreviewNameOptions(selId=""){
  let sel = document.getElementById("previewSelect");
  if(!sel){
    sel = document.createElement("select");
    sel.id = "previewSelect";
    sel.innerHTML = '<option value="">-- é¸æ“‡é è¦½æª”æ¡ˆ --</option>';
    const area = document.getElementById("savedArea");
    if(area) area.prepend(sel);
  }
  sel.innerHTML = '<option value="">-- é¸æ“‡é è¦½æª”æ¡ˆ --</option>';
  getPreviewNameList().forEach(n=>{
    const o=document.createElement("option");
    o.value=o.textContent=n;
    if(n===selId) o.selected=true;
    sel.appendChild(o);
  });
}
function loadPreviewFromLocal(){
  const sel = document.getElementById("previewSelect");
  if(!sel){ alert("æ‰¾ä¸åˆ°é¸æ“‡å™¨"); return; }
  const name = sel.value;
  if(!name){ alert("è«‹å…ˆé¸æ“‡æª”æ¡ˆ"); return; }
  const raw = localStorage.getItem("dynamicTableMultiPreview__"+name);
  console.log("è¼‰å…¥é è¦½è³‡æ–™ï¼š", raw);
  if(!raw){ alert("æ‰¾ä¸åˆ°è³‡æ–™ï¼"); refreshPreviewNameOptions(); return; }
  try{
    // ç›´æ¥åˆ·æ–°æ•´å€‹æš«å­˜/å®Œæˆå€
    refreshSavedArea();
    alert("å·²è¼‰å…¥é è¦½ã€Œ"+name+"ã€");
  }catch(e){
    alert("è³‡æ–™æ ¼å¼éŒ¯èª¤ï¼");
  }
}
// åˆå§‹åŒ–ä¸‹æ‹‰é¸å–®èˆ‡è®€å–æŒ‰éˆ•
(function(){
  document.addEventListener("DOMContentLoaded", () => {
    refreshPreviewNameOptions();
    let loadBtn = document.getElementById("previewLoadBtn");
    if(!loadBtn){
      loadBtn = document.createElement("button");
      loadBtn.id = "previewLoadBtn";
      loadBtn.textContent = "ğŸ“‚ è¼‰å…¥é è¦½";
      const area = document.getElementById("savedArea");
      if(area) area.prepend(loadBtn);
    }
    loadBtn.onclick = loadPreviewFromLocal;
    // é‡æ–°è®€å–æŒ‰éˆ•ç§»åˆ°è¼‰å…¥é è¦½æ—
    let reloadBtn = document.getElementById("reloadBtn");
    if(reloadBtn){
      reloadBtn.parentNode && reloadBtn.parentNode.removeChild(reloadBtn);
      loadBtn.insertAdjacentElement('afterend', reloadBtn);
      reloadBtn.onclick = loadPreviewFromLocal;
    }
  });
})();

      // domToV7 éœ€æ”¹ç‚ºè®€å– dynamicTableMultiPreview__ ä¸‹çš„ headerRows
function domToV7(tbl, headerRows) {
        // headerRows ç”±å‘¼å«ç«¯å‚³å…¥ï¼Œå·²ç”± dynamicTableMultiPreview__ å–å¾—
        const cols = leafCols(headerRows).length;
        const tdToHtml = (td) => {
          const clone = td.cloneNode(true);
          clone.querySelectorAll("input[type=checkbox]").forEach((inp) => {
            inp.checked
              ? inp.setAttribute("checked", "")
              : inp.removeAttribute("checked");
            inp.disabled = false;
          });
          clone.querySelectorAll("textarea").forEach((t) => {
            t.textContent = t.value;
          });
          clone.querySelectorAll("input[type=text]").forEach((inp) => {
            inp.setAttribute("value", inp.value);
          });
          clone.querySelectorAll(".del-btn").forEach((btn) => btn.remove());
          const srcCanv = [...td.querySelectorAll("canvas.sigCanvas")];
          const dstCanv = [...clone.querySelectorAll("canvas.sigCanvas")];
          srcCanv.forEach((src, i) => {
            const url = src.toDataURL();
            dstCanv[i].setAttribute("data-url", url);
          });
          return clone.innerHTML || "&nbsp;";
        };
        const body = [...tbl.querySelectorAll("tbody tr")].map((tr) => {
          const row = { color: "", cells: [] };
          let ci = 0;
          [...tr.children].forEach((td) => {
            const cs = td.colSpan || 1,
              rs = td.rowSpan || 1;
            // è®€å– align/color/size
            const style = window.getComputedStyle(td);
            const align = td.style.textAlign || style.textAlign || "left";
            const color = td.style.color || style.color || "#000";
            let size = td.style.fontSize || style.fontSize || "16px";
            if (typeof size === "string" && size.endsWith("px")) size = size.replace("px", "");
            size = parseInt(size) || 16;
            row.cells[ci] = {
              text: tdToHtml(td),
              colspan: cs,
              rowspan: rs,
              align,
              color,
              size
            };
            for (let i = 1; i < cs; i++)
              row.cells[ci + i] = { text: "", colspan: 1, rowspan: 1, align, color, size };
            ci += cs;
          });
          while (row.cells.length < cols)
            row.cells.push({ text: "", colspan: 1, rowspan: 1, align: "left", color: "#000", size: 16 });
          return row;
        });
        return { headerRows, dataRowsCfg: body };
      }

      document.getElementById("reloadBtn").onclick = refreshSavedArea;
      refreshSavedArea();
    </script>
  </body>
</html>
